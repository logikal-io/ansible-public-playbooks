#!/bin/bash
name="$(basename $0)"
usage="${name} [-h] -e email -p project -c configuration"
description="Log in to a Google Cloud account."
options="
  -h                show help
  -e email          the email address to use
  -p project        the default project to use
  -c configuration  the configuration to use
  -s                the scopes to use (can be 'stormware')
  -n                do not authenticate gcloud"

# Processing command-line arguments
emph="\e[1;34m"
reset="\e[0m"

_help() {
    echo -e "${emph}Usage:${reset} ${usage}\n"
    echo -e "${description}\n"
    echo -e "${emph}Options:${reset}${options}"
    exit
}

_arg_error() {
    echo "${name}: error: $1"
    echo "usage: ${usage}"
    exit 1
}

no_gcloud=false

while getopts 'he:p:c:s:n' flag; do
    case "${flag}" in
        h) _help ;;
        e) email="${OPTARG}" ;;
        p) project="${OPTARG}" ;;
        c) config="${OPTARG}" ;;
        s) scopes="${OPTARG}" ;;
        n) no_gcloud=true ;;
        *) _arg_error 'invalid arguments' ;;
    esac
done
if [[ -z "${config}" ]]; then _arg_error 'missing configuration'; fi

if [[ "${scopes}" == 'stormware' ]]; then
    scopes=( \
        'openid'
        'https://www.googleapis.com/auth/userinfo.email'
        'https://www.googleapis.com/auth/cloud-platform'
        'https://www.googleapis.com/auth/spreadsheets'
        'https://www.googleapis.com/auth/drive'
    )
    scopes="$(IFS=','; echo "${scopes[*]}")"
fi

# Logging in
gcloud="$HOME/.config/gcloud"
credentials="${gcloud}/credentials"

echo 'Checking configurations'
active=$(
    gcloud config configurations list "--filter=name~^${config}$" --format=json \
        | jq ".[0].is_active"
)
if [[ "${active}" == 'null' ]]; then
    if [[ -z "${email}" ]]; then _arg_error 'missing email'; fi
    if [[ -z "${project}" ]]; then _arg_error 'missing project'; fi

    gcloud config configurations create "${config}"
    gcloud config set disable_usage_reporting True
    gcloud config set account "${email}"
    gcloud auth login --configuration "${config}" --brief
    gcloud config set project "${project}" --quiet
else
    if [[ "${active}" == 'false' ]]; then
        gcloud config configurations activate "${config}"
    fi
    if [[ ${no_gcloud} = false ]]; then
        echo -e "\nLogging in to gcloud"
        gcloud auth login --configuration "${config}" --brief
    fi
fi

echo -e "\nCreating organization credentials file"
gcloud auth application-default login --configuration "${config}" \
    ${scopes:+"--scopes"} ${scopes:+"${scopes}"}
mkdir -p "${credentials}"
mv "${gcloud}/application_default_credentials.json" "${credentials}/${config}.json"

docker_config="$HOME/.docker/config.json"
if [[ ! $(cat "${docker_config}" | grep '"marketplace.gcr.io"') ]]; then
    echo 'Configuring Docker'
    gcloud auth configure-docker marketplace.gcr.io --configuration "${config}"
fi
